<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>title</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/vnd.microsoft.icon">
    <style type="text/css">
        select {
            width: 100%;
            height: 100%;
            min-height: 260px
        }
        
        option:nth-child(even) {
            background-color: lightgoldenrodyellow;
        }
        
        option:nth-child(odd) {
            background-color: white;
        }
        
        p {
            text-align: center
        }
        
        img {
            width: 300px
        }
        
        .ports {
            overflow: hidden;
            width: 50%;
        }
        
        .off-list {
            float: left;
            width: 50%;
            background-color: red;
            padding-bottom: 500em;
            margin-bottom: -500em;
        }
        
        .on-list {
            float: left;
            width: 50%;
            margin-right: -1px;
            border-left: 1px solid black;
            background-color: green;
            padding-bottom: 500em;
            margin-bottom: -500em;
        }
    </style>


</head>

<body>
    <div class="ports">
        <div class="off-list">
            <p>Off ports</p>
            <!--<select name="offs[]" id="offs" multiple="multiple" size="15" onclick="changeState(event);">-->
            <select name="offs[]" id="offs" multiple="multiple" size="15">
        </select>
        </div>
        <div class="on-list">
            <p>On ports</p>
            <!--<select name="ons[]" id="ons" multiple="multiple" size="15" onclick="changeState(event);">-->
            <select name="ons[]" id="ons" multiple="multiple" size="15">
        
            </select>
        </div>
    </div>
    <img src='./omega_pinout.png' />

    <script type="text/javascript">
        // pins from manual [0, 1, 6, 7, 8, 12, 13, 14, 15, 16, 17, 18, 19, 23, 26]
        // TODO: to be taken from backend
        var portsOff = [0, 1, 6, 7, 8, 12, 13, 14, 18, 19, 20, 21, 23, 26];
        var portsOn = [];
        populateSelects('offs', portsOff);
        populateSelects('ons', portsOn);

        function populateSelects(selectId, ports) {
            var sel = document.getElementById(selectId);
            for (var i = 0; i < ports.length; i++) {
                var opt = document.createElement('option');
                opt.innerHTML = ports[i];
                opt.value = ports[i];
                sel.appendChild(opt);
            }
        }

        // multiselect:
        (function () {
            var offList = document.getElementById('offs');
            var onList = document.getElementById('ons');

            function getSelectedOptions(selectingBox, otherBox, callbackFn) {
                var selOptions = [], opt;
                for (var i = 0, len = selectingBox.options.length; i < len; i++) {
                    opt = selectingBox.options[i];
                    if (opt.selected) {
                        selOptions.push(opt); // or parseInt(opt.value)
                    }
                }
                if (callbackFn) {
                    callbackFn(selectingBox, otherBox, selOptions);
                }
                return true;
            }

            offList.onchange = function (e) {
                getSelectedOptions(this, onList, changeState);
            };

            onList.onchange = function (e) {
                getSelectedOptions(this, offList, changeState);
            };
        }());

        function changeState(selectingBox, otherBox, selOptions) {
            selOptions.forEach(function(opt, index) {
                selectingBox.remove(selectingBox.selectedIndex);
                otherBox.options.add(opt, index);
            });
            
            sortSelect(otherBox);
            otherBox.selectedIndex = -1;
            
            var allOff = getItemsAsArray(selectingBox);
            var allOn = getItemsAsArray(otherBox);

            sendAjax({ 'allOff': allOff, 'allOn': allOn });
        }

        function sortSelect(otherBox) {
            var tmpAry = [];
            for (var i = 0; i < otherBox.options.length; i++) {
                tmpAry.push(otherBox.options[i]);
            }
            tmpAry.sort(function (a, b) {
                return (parseInt(a.value) < parseInt(b.value)) ? -1 : 1;
            });
            // while (otherBox.options.length > 0) {
            //     otherBox.options[0] = null;
            // }
            for (var i = 0; i < tmpAry.length; i++) {
                otherBox.options[i] = tmpAry[i];
            }
            return;
        }

        function getItemsAsArray(elem) {
            var tmpAry = [];
            for (var i = 0; i < elem.options.length; i++) {
                tmpAry.push(parseInt(elem.options[i].value));
            }
            return tmpAry;
        }

        function sendAjax(obj) {
            console.log('obj', JSON.stringify(obj));
            return ;

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/doMagic');
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    console.log(xhr.responseText);
                } else if (xhr.status !== 200) {
                    console.log('Request failed. Returned status: ', xhr.status);
                }
            }
            xhr.send(JSON.stringify(obj));
        }
    </script>
</body>
</html>